<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŸ¡ Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡ ØªØµØ§Ø¯Ù</title>
<style>
body {
  background: linear-gradient(135deg,#fffdf3,#fff5cc);
  font-family: Tahoma;
  display: flex;
  justify-content: center;
  align-items: start;
  padding: 40px 0;
  margin: 0;
  min-height: 100vh;
}
.container {
  background: white;
  border-radius: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  padding: 25px;
  width: 90%;
  max-width: 850px;
  box-sizing: border-box;
}
h2 { text-align: center; color: #6a4c00; margin-bottom: 25px; }
.section {
  background: #fffef7;
  border: 1px solid #ffe58a;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
}
.section h3 { margin-top: 0; color: #d68910; }
p { margin: 8px 0; }
textarea {
  width: 100%;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 10px;
  font-size: 14px;
  resize: vertical;
  min-height: 80px;
  box-sizing: border-box;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 13px;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
  line-height: 1.6;
}
th { background: #fff8dc; }
.btn {
  width: 230px;
  padding: 10px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  margin: 20px auto 0;
  display: block;
  font-size: 14px;
  font-weight: bold;
  transition: 0.3s;
}
.btn-primary { background: #f1c40f; color: #2c3e50; }
.btn-primary:hover { background: #e2b007; }
.btn-secondary { background: #bdc3c7; color: #2c3e50; }
.btn-secondary:hover { background: #a0a5a8; }
.table-wrapper { overflow-x: auto; border-radius: 10px; }
</style>
</head>
<body>

<div class="container">
  <h2>ğŸŸ¡ Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡ ØªØµØ§Ø¯Ù</h2>
  <div id="details"></div>

  <div class="section">
    <h3>ğŸš— Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§ÛŒ Ø¯Ø±Ú¯ÛŒØ±</h3>
    <div class="table-wrapper">
      <table id="carsTable">
        <thead>
          <tr>
            <th>Ù†Ù‚Ø´</th><th>Ù¾Ù„Ø§Ú©</th><th>Ù†ÙˆØ¹ Ø®ÙˆØ¯Ø±Ùˆ</th><th>Ú©Ø¯ Ù…Ù„ÛŒ Ø±Ø§Ù†Ù†Ø¯Ù‡</th><th>Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡</th>
            <th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§Ù†Ù†Ø¯Ù‡</th><th>Ù…Ø´Ø®ØµØ§Øª Ø³Ø±Ù†Ø´ÛŒÙ†</th><th>Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ø³ÛŒØ¨â€ŒØ¯ÛŒØ¯Ù‡</th><th>Ù…Ø¬Ø±ÙˆØ­ÛŒÙ†</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="section">
    <h3>ğŸš¶â€â™‚ï¸ Ø¹Ø§Ø¨Ø±Ø§Ù† Ù¾ÛŒØ§Ø¯Ù‡</h3>
    <div class="table-wrapper">
      <table id="pedTable">
        <thead>
          <tr><th>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</th><th>Ú©Ø¯ Ù…Ù„ÛŒ</th><th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="section">
    <h3>âœï¸ Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡</h3>
    <textarea id="resultText" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª ÛŒØ§ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ ØªØµØ§Ø¯Ù Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
    <button class="btn btn-primary" onclick="saveResult()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡</button>
    <button class="btn btn-secondary" onclick="window.location.href='result.html'">â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
  </div>
</div>

<script>
/* âœ… Ø³ÛŒØ³ØªÙ… Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø¨Ø§ Cordova Ùˆ Ù…Ø±ÙˆØ±Ú¯Ø± */
const smartStorage = {
  async get(key) {
    return new Promise(resolve => {
      if (window.NativeStorage) {
        NativeStorage.getItem(key, resolve, () => resolve(null));
      } else {
        const item = localStorage.getItem(key);
        try { resolve(item ? JSON.parse(item) : null); }
        catch { resolve(null); }
      }
    });
  },
  async set(key, value) {
    return new Promise(resolve => {
      if (window.NativeStorage) {
        NativeStorage.setItem(key, value, resolve, () => resolve());
      } else {
        localStorage.setItem(key, JSON.stringify(value));
        resolve();
      }
    });
  },
  async remove(key) {
    return new Promise(resolve => {
      if (window.NativeStorage) {
        NativeStorage.remove(key, resolve, () => resolve());
      } else {
        localStorage.removeItem(key);
        resolve();
      }
    });
  }
};

let crash = null;
let crashIndex = -1;

/* ğŸ“¦ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØµØ§Ø¯Ù */
window.addEventListener('DOMContentLoaded', async () => {
  crashIndex = parseInt(localStorage.getItem('selected_index'), 10);
  const allCrashes = await smartStorage.get('final_crashes') || [];
  crash = allCrashes[crashIndex] || null;

  const details = document.getElementById('details');
  if (!crash) {
    details.innerHTML = `<p style='text-align:center;'>âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>`;
    return;
  }

  // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ ØªØµØ§Ø¯Ù
  details.innerHTML = `
    <div class="section">
      <h3>ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ</h3>
      <p><strong>Ù…Ø­Ù„ Ø­Ø§Ø¯Ø«Ù‡:</strong> ${crash.address || "-"}</p>
      <p><strong>ØªØ§Ø±ÛŒØ®:</strong> ${crash.date || "-"}</p>
      <p><strong>Ø³Ø§Ø¹Øª:</strong> ${crash.time || "-"}</p>
      <p><strong>Ø´Ù…Ø§Ø±Ù‡ Ø®Ø¨Ø±:</strong> ${crash.reportNumber || "-"}</p>
    </div>
  `;
  document.getElementById('resultText').value = crash.result || "";

  // ğŸš— Ø¬Ø¯ÙˆÙ„ Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§
  const carsTable = document.querySelector('#carsTable tbody');
  carsTable.innerHTML = "";
  if (crash?.cars?.length > 0) {
    crash.cars.forEach(car => {
      const injureds = (car.injureds || []).map(i => `${i.name} (${i.nid})`).join("<br>") || "-";
      carsTable.innerHTML += `
        <tr>
          <td>${car.role || '-'}</td>
          <td>${car.plate || '-'}</td>
          <td>${car.carType || '-'}</td>
          <td>${car.nationalId || '-'}</td>
          <td>${car.passengerName || '-'}</td>
          <td>${car.phone || '-'}</td>
          <td>${car.passengerInfo || '-'}</td>
          <td>${car.damagedParts || '-'}</td>
          <td>${injureds}</td>
          <td>${car.description || '-'}</td>
        </tr>
      `;
    });
  } else {
    carsTable.innerHTML = `<tr><td colspan="10">ğŸš— Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯Ø±Ùˆ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>`;
  }

  // ğŸš¶â€â™‚ï¸ Ø¬Ø¯ÙˆÙ„ Ø¹Ø§Ø¨Ø±ÛŒÙ†
  const pedTable = document.querySelector('#pedTable tbody');
  pedTable.innerHTML = "";
  if (!crash.pedestrian?.hasPedestrian) {
    pedTable.innerHTML = `<tr><td colspan="3">ğŸš¶ Ù‡ÛŒÚ† Ø¹Ø§Ø¨Ø±ÛŒ Ø¯Ø± Ø§ÛŒÙ† ØªØµØ§Ø¯Ù ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</td></tr>`;
  } else if (!crash.pedestrian.data?.length) {
    pedTable.innerHTML = `<tr><td colspan="3">âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¹Ø§Ø¨Ø± Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>`;
  } else {
    crash.pedestrian.data.forEach(p => {
      pedTable.innerHTML += `
        <tr>
          <td>${p.name || '-'}</td>
          <td>${p.id || '-'}</td>
          <td>${p.phone || '-'}</td>
        </tr>
      `;
    });
  }
});

/* ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ ØªØµØ§Ø¯Ù */
async function saveResult() {
  const result = document.getElementById('resultText').value.trim();
  if (!result) return alert("âš ï¸ Ù„Ø·ÙØ§Ù‹ Ù†ØªÛŒØ¬Ù‡ ØªØµØ§Ø¯Ù Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");

  const finalCrashes = await smartStorage.get('final_crashes') || [];
  const completedCrashes = await smartStorage.get('completed_crashes') || [];

  if (crashIndex >= 0 && crashIndex < finalCrashes.length) {
    const updated = { ...finalCrashes[crashIndex], result };
    finalCrashes.splice(crashIndex, 1);
    completedCrashes.push(updated);

    await smartStorage.set('final_crashes', finalCrashes);
    await smartStorage.set('completed_crashes', completedCrashes);
    await smartStorage.remove('selected_index');

    alert("âœ… Ù†ØªÛŒØ¬Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ Ùˆ ØªØµØ§Ø¯Ù Ø¨Ù‡ Ù„ÛŒØ³Øª Ù†Ù‡Ø§ÛŒÛŒ Ù…Ù†ØªÙ‚Ù„ Ú¯Ø±Ø¯ÛŒØ¯.");
    window.location.href = "result.html";
  } else {
    alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡! Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
  }
}
</script>
</body>
</html>