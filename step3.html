<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø±Ø­Ù„Ù‡ Ø³ÙˆÙ… - Ø¹Ø§Ø¨Ø± Ù¾ÛŒØ§Ø¯Ù‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: linear-gradient(135deg,#f8fbff,#e0f0ff); font-family:Tahoma,sans-serif; display:flex; justify-content:center; align-items:flex-start; padding-top:40px; min-height:100vh; margin:0; }
    .form-container { background:#fff; padding:25px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); width:100%; max-width:380px; box-sizing:border-box; }
    h2 { text-align:center; color:#2c3e50; margin-bottom:25px; }
    input, select, button { width:100%; margin-top:10px; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:14px; box-sizing:border-box; }
    input:focus, select:focus { border-color:#3498db; box-shadow:0 0 5px rgba(52,152,219,0.4); outline:none; }
    button { background:#2980b9; color:white; cursor:pointer; border:none; border-radius:8px; padding:10px; margin-top:15px; transition:0.3s; }
    button:hover { opacity:0.9; }
    .back-btn { background:#7f8c8d; }
    .add-btn { background:#27ae60; }
    .pedestrian-list { margin-top:15px; background:#f9f9f9; padding:10px; border-radius:10px; max-height:200px; overflow-y:auto; font-size:13px; }
    .pedestrian-item { display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #ccc; padding:6px 0; }
    .delete-btn { background:#e74c3c; color:white; border:none; border-radius:6px; padding:3px 8px; cursor:pointer; font-size:12px; }
    .delete-btn:hover { opacity:0.8; }
    .error-box { background:#fdecea; color:#c0392b; border:1px solid #e74c3c; padding:6px 10px; border-radius:6px; margin-top:6px; font-size:12px; display:flex; align-items:center; gap:6px; animation:fadeIn 0.25s ease; }
    .error-box::before { content:"âš ï¸"; font-size:14px; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-3px);} to { opacity:1; transform:translateY(0);} }
    .error-input { border-color:#e74c3c !important; box-shadow:0 0 5px rgba(231,76,60,0.3); }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Ù…Ø±Ø­Ù„Ù‡ Ø³ÙˆÙ…: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¹Ø§Ø¨Ø± Ù¾ÛŒØ§Ø¯Ù‡ ğŸ§</h2>

    <select id="pedestrianStatus" onchange="toggleFields()">
      <option value="">Ø¢ÛŒØ§ Ø¹Ø§Ø¨Ø± Ù¾ÛŒØ§Ø¯Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŸ</option>
      <option value="yes">Ø¯Ø§Ø±Ø¯</option>
      <option value="no">Ù†Ø¯Ø§Ø±Ø¯</option>
    </select>

    <div id="pedestrianFields" style="display:none;">
      <input type="text" id="pedestrianName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
      <div id="errorName"></div>
      <input type="text" id="pedestrianId" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ Ø¹Ø§Ø¨Ø±" maxlength="10" inputmode="numeric" oninput="digitsOnly(this,10)">
      <div id="errorId"></div>
      <input type="text" id="pedestrianPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¹Ø§Ø¨Ø±" maxlength="11" inputmode="numeric" oninput="digitsOnly(this,11)">
      <div id="errorPhone"></div>
      <button type="button" class="add-btn" onclick="addPedestrian()">â• Ø«Ø¨Øª Ø¹Ø§Ø¨Ø±</button>
      <div class="pedestrian-list" id="pedestrianList"></div>
    </div>

    <button onclick="nextStep()">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ÛŒ</button>
    <button class="back-btn" onclick="window.location.href='step2.html'">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
  </div>

  <script src="storage.js"></script>
  <script>
    let pedestrians = [];
    let currentCrash = null;

    function digitsOnly(el, maxLen) {
      el.value = el.value.replace(/\D/g, '').slice(0, maxLen);
    }

    function toggleFields() {
      clearErrors();
      const status = document.getElementById('pedestrianStatus').value;
      const fields = document.getElementById('pedestrianFields');
      if (status === "yes") {
        fields.style.display = "block";
      } else {
        fields.style.display = "none";
        pedestrians = [];
        updatePedestrianList();
      }
    }

    function showError(id, msg) {
      const c = document.getElementById(id);
      if (c) c.innerHTML = `<div class="error-box">${msg}</div>`;
    }

    function clearErrors() {
      document.querySelectorAll('.error-box').forEach(e => e.remove());
      document.querySelectorAll('.error-input').forEach(e => e.classList.remove('error-input'));
    }

    function updatePedestrianList() {
      const list = document.getElementById('pedestrianList');
      list.innerHTML = "";
      pedestrians.forEach((p, i) => {
        list.innerHTML += `
          <div class="pedestrian-item">
            <span>[${i + 1}] ${p.name} - Ú©Ø¯Ù…Ù„ÛŒ: ${p.id} - ØªÙ„ÙÙ†: ${p.phone}</span>
            <button class="delete-btn" onclick="deletePedestrian(${i})">Ø­Ø°Ù</button>
          </div>`;
      });
    }

    function deletePedestrian(i) {
      pedestrians.splice(i, 1);
      updatePedestrianList();
    }

    async function addPedestrian() {
      clearErrors();
      const name = document.getElementById('pedestrianName').value.trim();
      const id = document.getElementById('pedestrianId').value.trim();
      const phone = document.getElementById('pedestrianPhone').value.trim();

      let valid = true;
      if (!name) {
        showError("errorName", "Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.");
        document.getElementById('pedestrianName').classList.add("error-input");
        valid = false;
      }
      if (!/^\d{10}$/.test(id)) {
        showError("errorId", "Ú©Ø¯ Ù…Ù„ÛŒ Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Û±Û° Ø±Ù‚Ù… Ø¹Ø¯Ø¯ÛŒ Ø¨Ø§Ø´Ø¯.");
        document.getElementById('pedestrianId').classList.add("error-input");
        valid = false;
      }
      if (!/^\d{11}$/.test(phone)) {
        showError("errorPhone", "Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Û±Û± Ø±Ù‚Ù… Ø¹Ø¯Ø¯ÛŒ Ø¨Ø§Ø´Ø¯.");
        document.getElementById('pedestrianPhone').classList.add("error-input");
        valid = false;
      }
      if (!valid) return;

      pedestrians.push({ name, id, phone });
      updatePedestrianList();

      document.getElementById('pedestrianName').value = "";
      document.getElementById('pedestrianId').value = "";
      document.getElementById('pedestrianPhone').value = "";

      if (currentCrash) {
        currentCrash.pedestrian = { hasPedestrian: true, data: pedestrians };
        await smartStorage.set('current_crash', currentCrash);
        await smartStorage.set(`pedestrians_${currentCrash.id}`, pedestrians);
      }
    }

    async function nextStep() {
      clearErrors();
      const status = document.getElementById('pedestrianStatus').value;
      if (!status) {
        showError("errorName", "Ù„Ø·ÙØ§Ù‹ ÙˆØ¶Ø¹ÛŒØª Ø¹Ø§Ø¨Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
        document.getElementById("pedestrianStatus").classList.add("error-input");
        return;
      }

      if (status === "yes" && pedestrians.length === 0) {
        showError("errorName", "Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¹Ø§Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ø«Ø¨Øª Ø´ÙˆØ¯.");
        return;
      }

      if (!currentCrash || !currentCrash.id) {
        alert("âŒ Ø´Ù†Ø§Ø³Ù‡ ØªØµØ§Ø¯Ù ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.");
        window.location.href = "step1.html";
        return;
      }

      currentCrash.pedestrian = {
        hasPedestrian: status === "yes",
        data: status === "yes" ? pedestrians : []
      };

      await smartStorage.set('current_crash', currentCrash);
      await smartStorage.set(`pedestrians_${currentCrash.id}`, currentCrash.pedestrian);

      console.log("âœ… Ø¹Ø§Ø¨Ø±Ù‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯:", currentCrash.pedestrian);

      window.location.href = 'step4.html';
    }

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        currentCrash = await smartStorage.get('current_crash');
        if (!currentCrash || !currentCrash.id) {
          alert("âš ï¸ Ø´Ù†Ø§Ø³Ù‡ ØªØµØ§Ø¯Ù ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.");
          window.location.href = "step1.html";
          return;
        }

        const pedData = await smartStorage.get(`pedestrians_${currentCrash.id}`);
        if (pedData && Array.isArray(pedData)) {
          document.getElementById('pedestrianStatus').value = "yes";
          document.getElementById('pedestrianFields').style.display = "block";
          pedestrians = pedData.slice();
          updatePedestrianList();
        } else if (currentCrash.pedestrian) {
          const ped = currentCrash.pedestrian;
          if (ped.hasPedestrian) {
            document.getElementById('pedestrianStatus').value = "yes";
            document.getElementById('pedestrianFields').style.display = "block";
            pedestrians = Array.isArray(ped.data) ? ped.data.slice() : [];
            updatePedestrianList();
          } else {
            document.getElementById('pedestrianStatus').value = "no";
            document.getElementById('pedestrianFields').style.display = "none";
          }
        }
      } catch (e) {
        console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¹Ø§Ø¨Ø±Ù‡Ø§:", e);
      }
    });
  </script>
</body>
</html>