<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø±Ø­Ù„Ù‡ Ú†Ù‡Ø§Ø±Ù… - Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‡Ø§ÛŒÛŒ</title>
  <style>
    body { background: linear-gradient(135deg,#eef5ff,#fefefe); font-family: Tahoma; display:flex; justify-content:center; align-items:flex-start; padding-top:40px; min-height:100vh; margin:0; }
    .container { background:#fff; padding:25px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); width:90%; max-width:900px; animation:fadeIn 0.4s ease; box-sizing:border-box; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    h2{text-align:center;margin-bottom:25px;color:#2c3e50;}
    .section{margin-bottom:25px;padding:20px;border:1px solid #dce7f5;border-radius:12px;background:#f9fcff;}
    .section h3{margin-top:0;color:#2980b9;font-size:16px;margin-bottom:10px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px;}
    th, td{border:1px solid #cfd8dc;padding:8px;text-align:center;line-height:1.6;}
    th{background:#e3f2fd;color:#2c3e50;font-weight:bold;}
    tr:nth-child(even){background-color:#f9f9f9;}
    tr:hover td{background-color:#f0faff;}
    .table-wrapper{overflow-x:auto;border-radius:10px;}
    .btn{width:100%; max-width:200px; padding:10px; border-radius:8px; border:none; cursor:pointer; font-size:14px; display:inline-block; transition:background 0.3s ease; margin:5px; box-sizing:border-box;}
    .btn-blue{background:#3498db;color:white;}
    .btn-blue:hover{background:#2c80b9;}
    .btn-gray{background:#7f8c8d;color:white;}
    .btn-gray:hover{background:#6c7a7a;}
    .buttons{text-align:center;margin-top:20px;display:flex;flex-wrap:wrap;justify-content:center;}
  </style>
</head>
<body>
  <div class="container">
    <h2>Ù…Ø±Ø­Ù„Ù‡ Ú†Ù‡Ø§Ø±Ù…: Ø¨Ø±Ø±Ø³ÛŒ Ùˆ ØªØ£ÛŒÛŒØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h2>

    <div class="section">
      <h3>ğŸ“„ Ù…Ø´Ø®ØµØ§Øª Ø§ÙˆÙ„ÛŒÙ‡ ØªØµØ§Ø¯Ù</h3>
      <p><strong>Ø´Ù…Ø§Ø±Ù‡ Ø®Ø¨Ø±:</strong> <span id="reportNumber">-</span></p>
      <p><strong>ØªØ§Ø±ÛŒØ®:</strong> <span id="date">-</span></p>
      <p><strong>Ø³Ø§Ø¹Øª:</strong> <span id="time">-</span></p>
      <p><strong>Ø¢Ø¯Ø±Ø³:</strong> <span id="address">-</span></p>
    </div>

    <div class="section">
      <h3>ğŸš— Ù…Ø´Ø®ØµØ§Øª Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§</h3>
      <div class="table-wrapper">
        <table id="carsTable">
          <thead>
            <tr>
              <th>Ù†Ù‚Ø´</th><th>Ù¾Ù„Ø§Ú©</th><th>Ù†ÙˆØ¹ Ø®ÙˆØ¯Ø±Ùˆ</th><th>Ú©Ø¯ Ù…Ù„ÛŒ Ø±Ø§Ù†Ù†Ø¯Ù‡</th><th>Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡</th>
              <th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</th><th>Ù…Ø´Ø®ØµØ§Øª Ø³Ø±Ù†Ø´ÛŒÙ†</th><th>Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ø³ÛŒØ¨â€ŒØ¯ÛŒØ¯Ù‡</th><th>Ù…Ø¬Ø±ÙˆØ­ÛŒÙ†</th><th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h3>ğŸš¶â€â™‚ï¸ Ø¹Ø§Ø¨Ø±Ø§Ù† Ù¾ÛŒØ§Ø¯Ù‡</h3>
      <div class="table-wrapper">
        <table id="pedestriansTable">
          <thead>
            <tr><th>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</th><th>Ú©Ø¯ Ù…Ù„ÛŒ</th><th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="buttons">
      <button class="btn btn-blue" onclick="finalizeCrash()">âœ… Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ</button>
      <button class="btn btn-gray" onclick="window.location.href='step3.html'">â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>
  </div>

  <script src="storage.js"></script>
  <script>
    let currentCrash = null;
    let cars = [];

    async function loadData() {
      // ğŸ“¦ Ø®ÙˆØ§Ù†Ø¯Ù† Ø´Ù†Ø§Ø³Ù‡ ØªØµØ§Ø¯Ù
      currentCrash = await smartStorage.get('current_crash');
      if (!currentCrash || !currentCrash.id) {
        alert("âš ï¸ Ø´Ù†Ø§Ø³Ù‡ ØªØµØ§Ø¯Ù ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.");
        window.location.href = "step1.html";
        return;
      }

      // ğŸ§¾ Ù…Ø´Ø®ØµØ§Øª Ø§ÙˆÙ„ÛŒÙ‡
      document.getElementById('reportNumber').textContent = currentCrash.reportNumber || "-";
      document.getElementById('date').textContent = currentCrash.date || "-";
      document.getElementById('time').textContent = currentCrash.time || "-";
      document.getElementById('address').textContent = currentCrash.address || "-";

      // ğŸš— Ø®ÙˆØ§Ù†Ø¯Ù† Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§
      cars = await smartStorage.get('cars_' + currentCrash.id) || [];
      const carsTable = document.querySelector('#carsTable tbody');
      if (!cars.length) {
        carsTable.innerHTML = `<tr><td colspan="10">ğŸš— Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯Ø±Ùˆ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>`;
      } else {
        carsTable.innerHTML = cars.map(car => {
          const injureds = (car.injureds || []).map(i => `${i.name} (${i.nid})`).join("<br>") || "-";
          return `<tr>
            <td>${car.role || '-'}</td>
            <td>${car.plate || '-'}</td>
            <td>${car.carType || '-'}</td>
            <td>${car.nationalId || '-'}</td>
            <td>${car.passengerName || '-'}</td>
            <td>${car.phone || '-'}</td>
            <td>${car.passengerInfo || '-'}</td>
            <td>${car.damagedParts || '-'}</td>
            <td>${injureds}</td>
            <td>${car.description || '-'}</td>
          </tr>`;
        }).join("");
      }

      // ğŸš¶â€â™‚ï¸ Ù†Ù…Ø§ÛŒØ´ Ø¹Ø§Ø¨Ø±Ù‡Ø§
      const pedTable = document.querySelector('#pedestriansTable tbody');
      const pedestrian = currentCrash.pedestrian || { hasPedestrian: false, data: [] };
      if (!pedestrian.hasPedestrian) {
        pedTable.innerHTML = `<tr><td colspan="3">ğŸš¶ Ù‡ÛŒÚ† Ø¹Ø§Ø¨Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>`;
      } else if (!pedestrian.data.length) {
        pedTable.innerHTML = `<tr><td colspan="3">âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¹Ø§Ø¨Ø± Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>`;
      } else {
        pedTable.innerHTML = pedestrian.data.map(p => `
          <tr>
            <td>${p.name || '-'}</td>
            <td>${p.id || '-'}</td>
            <td>${p.phone || '-'}</td>
          </tr>`).join("");
      }
    }

    async function finalizeCrash() {
      if (!currentCrash || !currentCrash.id) {
        alert("âš ï¸ Ø´Ù†Ø§Ø³Ù‡ ØªØµØ§Ø¯Ù ÛŒØ§ÙØª Ù†Ø´Ø¯.");
        return;
      }

      // ğŸ§© ØªØ±Ú©ÛŒØ¨ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
      const finalData = {
        ...currentCrash,
        cars: cars,
        pedestrian: currentCrash.pedestrian || { hasPedestrian: false, data: [] },
        finalizedAt: new Date().toLocaleString('fa-IR')
      };

      // ğŸ“¦ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù„ÛŒØ³Øª Ù†Ù‡Ø§ÛŒÛŒ
      let allCrashes = await smartStorage.get('final_crashes') || [];
      allCrashes.push(finalData);
      await smartStorage.set('final_crashes', allCrashes);

      // ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª
      await smartStorage.remove('cars_' + currentCrash.id);
      await smartStorage.remove('current_crash');

      alert("âœ… ØªØµØ§Ø¯Ù Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.");
      window.location.href = "index.html";
    }

    window.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>