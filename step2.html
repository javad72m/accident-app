<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ğŸš˜ Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ… - Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯Ø±Ùˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{margin:0;font-family:'Tahoma',sans-serif;background:linear-gradient(135deg,#e3f2fd,#bbdefb);display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:30px 10px;}
  .form-container{background:#fff;padding:25px 20px;border-radius:20px;box-shadow:0 6px 25px rgba(0,0,0,0.1);width:100%;max-width:400px;}
  h2{text-align:center;color:#1565c0;margin-bottom:20px;}
  input,select,textarea,.btn{width:100%;padding:10px;margin-top:10px;font-size:14px;border-radius:10px;border:1px solid #ccc;transition:0.3s;box-sizing:border-box;}
  input:focus,select:focus,textarea:focus{border-color:#42a5f5;box-shadow:0 0 6px rgba(66,165,245,0.4);outline:none;}
  .row{display:flex;gap:10px;}
  .row input,.row select{flex:1;}
  .btn{cursor:pointer;border:none;color:#fff;font-weight:bold;transition:0.3s;}
  .btn-green{background:linear-gradient(to right,#2ecc71,#27ae60);}
  .btn-blue{background:linear-gradient(to right,#42a5f5,#1e88e5);}
  .btn-gray{background:linear-gradient(to right,#9e9e9e,#757575);}
  .btn:hover{transform:translateY(-2px);opacity:0.95;}
  .car-list,.injured-list{margin-top:15px;background:#f8f9fa;border-radius:10px;padding:10px;max-height:150px;overflow-y:auto;font-size:13px;}
  .item{border-bottom:1px dashed #ccc;padding:6px 0;display:flex;justify-content:space-between;align-items:center;gap:5px;}
  .btn-small{border:none;border-radius:6px;padding:3px 8px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:3px;}
  .delete-btn{background:#e74c3c;color:#fff;}
  .edit-btn{background:#3498db;color:#fff;}
  footer{text-align:center;margin-top:15px;color:#666;font-size:13px;}
  input.error, select.error, textarea.error {border-color:#e74c3c;box-shadow:0 0 6px rgba(231,76,60,0.5);}
  @media(max-width:480px){.form-container{padding:25px 15px;}}
</style>
</head>
<body>
<div class="form-container">
  <h2>ğŸš˜ Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ…: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯Ø±Ùˆ</h2>

  <select id="role">
    <option value="">Ù†Ù‚Ø´ Ø®ÙˆØ¯Ø±Ùˆ</option>
    <option value="Ù…Ù‚ØµØ±">Ù…Ù‚ØµØ±</option>
    <option value="ØºÛŒØ± Ù…Ù‚ØµØ±">ØºÛŒØ± Ù…Ù‚ØµØ±</option>
  </select>

  <div class="row">
    <input type="text" id="plate" placeholder="Ù¾Ù„Ø§Ú© Ø®ÙˆØ¯Ø±Ùˆ">
    <input type="text" id="carType" placeholder="Ù†ÙˆØ¹ Ø®ÙˆØ¯Ø±Ùˆ">
  </div>

  <div class="row">
    <input type="tel" id="nationalId" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ Ø±Ø§Ù†Ù†Ø¯Ù‡" maxlength="10" inputmode="numeric">
    <input type="tel" id="phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø±Ø§Ù†Ù†Ø¯Ù‡ (Û±Û± Ø±Ù‚Ù…)" maxlength="11" inputmode="numeric">
  </div>

  <div class="row">
    <input type="text" id="passengerName" placeholder="Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡">
    <input type="text" id="passengerInfo" placeholder="Ù…Ø´Ø®ØµØ§Øª Ø³Ø±Ù†Ø´ÛŒÙ†">
  </div>

  <input type="text" id="damagedParts" placeholder="Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ø³ÛŒØ¨â€ŒØ¯ÛŒØ¯Ù‡">

  <select id="injuredSelect" onchange="toggleInjuredForm()">
    <option value="">Ø¢ÛŒØ§ Ù…Ø¬Ø±ÙˆØ­ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŸ</option>
    <option value="no">Ù…Ø¬Ø±ÙˆØ­ Ù†Ø¯Ø§Ø±Ø¯</option>
    <option value="yes">Ù…Ø¬Ø±ÙˆØ­ Ø¯Ø§Ø±Ø¯</option>
  </select>

  <div id="injuredForm" style="display:none;">
    <input type="text" id="injuredName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ù…Ø¬Ø±ÙˆØ­">
    <input type="tel" id="injuredNationalId" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¬Ø±ÙˆØ­" maxlength="10" inputmode="numeric">
    <button class="btn btn-green" type="button" onclick="addInjured()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø¬Ø±ÙˆØ­</button>
  </div>

  <div class="injured-list" id="injuredList"></div>
  <textarea id="description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒ"></textarea>

  <button class="btn btn-green" onclick="addOrUpdateCar()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø®ÙˆØ¯Ø±Ùˆ</button>
  <div class="car-list" id="carList"></div>

  <button class="btn btn-blue" onclick="goNext()">Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ÛŒ â­ï¸</button>
  <button class="btn btn-gray" onclick="goBack()">Ø¨Ø§Ø²Ú¯Ø´Øª â†©ï¸</button>

  <footer>Ù…Ø±Ø­Ù„Ù‡ Û² Ø§Ø² Û´</footer>
</div>

<script src="storage.js"></script>
<script>
(async function() {
  const current = await smartStorage.get('current_crash');
  if (!current || !current.id) {
    alert("â— Ø´Ù†Ø§Ø³Ù‡ ØªØµØ§Ø¯Ù ÛŒØ§ÙØª Ù†Ø´Ø¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.");
    window.location.href = "step1.html";
    return;
  }

  let cars = await smartStorage.get('cars_' + current.id) || [];
  let injureds = [];
  let editIndex = null;

  const fields = {
    role: role, plate: plate, carType: carType, nationalId: nationalId,
    phone: phone, passengerName: passengerName, passengerInfo: passengerInfo,
    damagedParts: damagedParts, description: description
  };

  window.toggleInjuredForm = function() {
    injuredForm.style.display = injuredSelect.value === "yes" ? "block" : "none";
  };

  window.addInjured = async function() {
    const name = injuredName.value.trim();
    const nid = injuredNationalId.value.trim();
    if (!name || !/^[0-9]{10}$/.test(nid)) {
      alert("Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø¬Ø±ÙˆØ­ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
      return;
    }
    injureds.push({ name, nid });
    await smartStorage.set('injureds_' + current.id, injureds);
    updateInjuredList();
    injuredName.value = "";
    injuredNationalId.value = "";
    injuredSelect.value = "no";
    toggleInjuredForm();
  };

  function updateInjuredList() {
    injuredList.innerHTML = "";
    injureds.forEach((inj, i) => {
      injuredList.innerHTML += `
        <div class="item">
          <span>[${i + 1}] ${inj.name} - ${inj.nid}</span>
          <button class='delete-btn btn-small' onclick='deleteInjured(${i})'>âŒ Ø­Ø°Ù</button>
        </div>`;
    });
  }

  window.deleteInjured = async function(i) {
    injureds.splice(i, 1);
    await smartStorage.set('injureds_' + current.id, injureds);
    updateInjuredList();
  };

  window.addOrUpdateCar = async function() {
    let valid = true;
    Object.values(fields).forEach(el => {
      el.classList.remove("error");
      if (!el.value.trim()) { el.classList.add("error"); valid = false; }
    });
    if (!valid) return alert("âš ï¸ Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.");

    if (!/^[0-9]{10}$/.test(fields.nationalId.value.trim())) {
      fields.nationalId.classList.add("error");
      return alert("Ú©Ø¯ Ù…Ù„ÛŒ Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Û±Û° Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯.");
    }
    if (!/^[0-9]{11}$/.test(fields.phone.value.trim())) {
      fields.phone.classList.add("error");
      return alert("Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ Û±Û± Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯.");
    }

    const carData = Object.fromEntries(Object.entries(fields).map(([k,v]) => [k,v.value.trim()]));
    carData.injureds = [...injureds];

    if (editIndex !== null) {
      cars[editIndex] = carData;
      editIndex = null;
      alert("âœ… Ø®ÙˆØ¯Ø±Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯.");
    } else {
      cars.push(carData);
    }

    await smartStorage.set('cars_' + current.id, cars);
    current.cars = cars;
    await smartStorage.set('current_crash', current);

    updateCarList();
    injureds = [];
    await smartStorage.set('injureds_' + current.id, injureds);
    updateInjuredList();
    Object.values(fields).forEach(el => el.value = "");
    injuredSelect.value = "";
  };

  function updateCarList() {
    carList.innerHTML = "";
    cars.forEach((c, i) => {
      carList.innerHTML += `
        <div class='item'>
          <span>[${i + 1}] ${c.role} | ${c.plate} | ${c.carType} | ${c.passengerName}</span>
          <div style="display:flex;gap:4px;">
            <button class='edit-btn btn-small' onclick='editCar(${i})'>âœï¸</button>
            <button class='delete-btn btn-small' onclick='deleteCar(${i})'>ğŸ—‘ï¸</button>
          </div>
        </div>`;
    });
  }

  window.editCar = function(i) {
    const c = cars[i];
    for (const [k, el] of Object.entries(fields)) el.value = c[k];
    injureds = [...c.injureds];
    updateInjuredList();
    editIndex = i;
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  window.deleteCar = async function(i) {
    cars.splice(i, 1);
    await smartStorage.set('cars_' + current.id, cars);
    current.cars = cars;
    await smartStorage.set('current_crash', current);
    updateCarList();
  };

  window.goNext = async function() {
    if (cars.length === 0) return alert("Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø®ÙˆØ¯Ø±Ùˆ Ø¨Ø§ÛŒØ¯ Ø«Ø¨Øª Ø´ÙˆØ¯.");
    current.cars = cars;
    await smartStorage.set('current_crash', current);
    await smartStorage.set('inProgress', '1');
    window.location.href = 'step3.html';
  };

  window.goBack = async function() {
    await smartStorage.set('cars_' + current.id, cars);
    window.location.href = 'step1.html';
  };

  if (cars.length > 0) updateCarList();
})();
</script>
</body>
</html>